name: Publish Exported Sites Showcase

on:
  push:
    branches:
      - main
    paths:
      - "exported-sites/**"
      - ".github/workflows/deploy-exported-site.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "publish-user-site"
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      SOURCE_DIR: exported-sites
      TARGET_REPO: keneth4/keneth4.github.io
      TARGET_BRANCH: main
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Validate showcase folder
        run: |
          if [ ! -d "${SOURCE_DIR}" ]; then
            echo "Showcase folder does not exist: ${SOURCE_DIR}" >&2
            exit 1
          fi

      - name: Build showcase index
        run: |
          ROOT="${SOURCE_DIR}"
          INDEX_PATH="${ROOT}/index.html"
          mapfile -t SITE_INDEXES < <(find "$ROOT" -mindepth 2 -maxdepth 2 -type f -name "index.html" | sort)

          {
            echo "<!doctype html>"
            echo "<html lang=\"en\">"
            echo "  <head>"
            echo "    <meta charset=\"UTF-8\" />"
            echo "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />"
            echo "    <title>MenuMaker Client Demos</title>"
            echo "    <style>"
            echo "      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif; background: #f4f6f8; color: #1f2937; }"
            echo "      main { max-width: 900px; margin: 0 auto; padding: 2.5rem 1rem 3rem; }"
            echo "      h1 { margin: 0 0 0.5rem; font-size: 2rem; }"
            echo "      p { margin: 0 0 1.5rem; color: #4b5563; }"
            echo "      ul { list-style: none; padding: 0; margin: 0; display: grid; gap: 0.75rem; }"
            echo "      a { display: block; padding: 0.85rem 1rem; border-radius: 0.65rem; background: #ffffff; border: 1px solid #d1d5db; text-decoration: none; color: #111827; font-weight: 600; }"
            echo "      a:hover { border-color: #111827; }"
            echo "      .empty { padding: 0.85rem 1rem; border-radius: 0.65rem; background: #ffffff; border: 1px dashed #d1d5db; color: #6b7280; }"
            echo "    </style>"
            echo "  </head>"
            echo "  <body>"
            echo "    <main>"
            echo "      <h1>MenuMaker Client Demos</h1>"
            echo "      <p>Published samples from <code>exported-sites/</code>.</p>"
            echo "      <ul>"
            if [ "${#SITE_INDEXES[@]}" -eq 0 ]; then
              echo "        <li class=\"empty\">No sample sites found yet.</li>"
            else
              for site_index in "${SITE_INDEXES[@]}"; do
                site_dir="$(dirname "$site_index")"
                site_slug="${site_dir#${ROOT}/}"
                printf "        <li><a href=\"./%s/\">%s</a></li>\n" "$site_slug" "$site_slug"
              done
            fi
            echo "      </ul>"
            echo "    </main>"
            echo "  </body>"
            echo "</html>"
          } > "$INDEX_PATH"

      - name: Sync showcase to user site repo
        env:
          PAGES_DEPLOY_TOKEN: ${{ secrets.PAGES_DEPLOY_TOKEN }}
        run: |
          if [ -z "${PAGES_DEPLOY_TOKEN}" ]; then
            echo "Missing required secret: PAGES_DEPLOY_TOKEN" >&2
            exit 1
          fi

          TARGET_DIR="${RUNNER_TEMP}/user-site"
          git clone --depth 1 --branch "${TARGET_BRANCH}" \
            "https://x-access-token:${PAGES_DEPLOY_TOKEN}@github.com/${TARGET_REPO}.git" \
            "${TARGET_DIR}"

          rsync -av --delete \
            --exclude ".git/" \
            --exclude "CNAME" \
            "${SOURCE_DIR}/" "${TARGET_DIR}/"

          touch "${TARGET_DIR}/.nojekyll"

          cd "${TARGET_DIR}"
          if [ -z "$(git status --porcelain)" ]; then
            echo "No publish changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Publish demos from ${GITHUB_REPOSITORY}@${GITHUB_SHA}"
          git push origin "${TARGET_BRANCH}"
