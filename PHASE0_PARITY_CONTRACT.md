# Phase 0 Parity Contract (Preview vs Exported Site)

## Goal
Ensure the in-editor preview and exported static site behave the same for all high-value interactions. The exported site is the production artifact, so parity is a release requirement.

## Scope
- In-editor preview runtime (`src/App.svelte` + UI components)
- Exported site runtime generated by `buildExportScript` (`src/App.svelte`)

## Out of scope (Phase 0)
- New product features (logo mode, rotation settings UI, keyboard additions)
- Visual redesign unrelated to parity
- Large architecture moves not required for parity

## Parity requirements
| Area | Contract | Verification |
| --- | --- | --- |
| Template behavior | Same template strategy behavior (`focus-rows`, `jukebox`) in preview/export. | Fixture-based e2e parity checks. |
| Section navigation | Same snapping axis/delay and section switching behavior. | Interaction parity e2e checks. |
| Carousel navigation | Same wheel/touch/desktop controls and normalization behavior. | Interaction parity e2e checks. |
| Modal lifecycle | Same open/close rules, overlay click behavior, and media setup/teardown behavior. | Modal parity e2e checks. |
| Rotation behavior | Same rotation direction source and drag behavior in preview/export. | Interactive media parity e2e checks. |
| Image source policy | Same source selection for carousel/detail and same responsive fallback order. | DOM assertions + network/request pattern checks. |
| Derivative usage policy | Same derivative class resolution (`background md/lg`, `dish md/lg`) and same derived format preference (`webp` profile rules) for matching viewport/device conditions. | Fixture parity checks + request assertions. |
| Localization/currency | Same locale fallback and currency display output. | Snapshot/assertion parity checks. |
| Startup loading behavior | Same first-view/blocking source set semantics. | Startup plan parity assertions. |

## Current known drift risk
- `buildExportScript` in `src/App.svelte` duplicates behavior that already exists in app runtime logic.
- Preview and export runtime both carry versions of:
  - template constants and interaction helpers,
  - image source selection and startup preload rules,
  - modal interactive media setup/teardown,
  - keyboard/event wiring.
- Prioritized hotspot inventory is tracked in `PHASE_STATUS_TRACKER.md` (`Drift inventory (2026-02-09)` section).
- Selected first extraction slice is tracked in `PHASE0_EXTRACTION_SLICE_01.md`.

## Phase 0 execution checklist
- [x] Define and publish parity contract.
- [x] Inventory duplicated preview/export runtime logic with priority labels.
- [x] Select first shared runtime extraction slice with lowest break risk.
- [x] Implement shared helper module(s) and consume from preview + export builders.
- [x] Add parity e2e spec comparing preview and exported runtime against same fixture.
- [x] Add parity spec to required CI/local gate list.

Implemented parity e2e:
- `tests/e2e/parity-image-sources.spec.ts`
- Required local gate command: `npm run test:e2e -- tests/e2e/parity-image-sources.spec.ts`

## Exit criteria
- Contract is approved and tracked.
- Critical parity checks are automated.
- No open high-severity preview/export drift remains.
